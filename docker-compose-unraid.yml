# NOTE: This file is optimized for Unraid USB Sticks.
# It DOES NOT build images. It downloads Node.js and installs dependencies at runtime.
# This prevents permission errors on /boot.

services:
  browserless:
    image: ghcr.io/browserless/chromium:latest
    container_name: forum_browserless
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - TIMEOUT=60000
    networks:
      - unraid_sniper_net

  backend:
    image: node:18-alpine
    container_name: forum_backend
    working_dir: /app
    restart: unless-stopped
    ports:
      - "4000:4000"
    volumes:
      # Map source code
      - ./server:/app
      # PERSISTENT named volume for node_modules (Crucial for performance/USB health)
      - backend_node_modules:/app/node_modules
    environment:
      - BROWSERLESS_HOST=browserless
      - PORT=4000
    depends_on:
      - browserless
    networks:
      - unraid_sniper_net
    # Install deps on start, then run
    command: /bin/sh -c "npm install && npm start"

  frontend:
    image: node:18-alpine
    container_name: forum_frontend
    working_dir: /app
    restart: unless-stopped
    ports:
      - "5173:5173"
    volumes:
      - ./client:/app
      # PERSISTENT named volume for node_modules
      - frontend_node_modules:/app/node_modules
    environment:
      # REPLACE WITH YOUR UNRAID IP IF NEEDED
      - VITE_API_URL=http://192.168.1.16:4000
    networks:
      - unraid_sniper_net
    # Install deps on start, then run dev
    command: /bin/sh -c "npm install && npm run dev -- --host"

networks:
  unraid_sniper_net:
    driver: bridge

volumes:
  backend_node_modules:
  frontend_node_modules:
